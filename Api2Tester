//https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind/2.1.4

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableCellRenderer;
import java.awt.*;
import java.awt.event.*;
import java.io.*;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import com.fasterxml.jackson.databind.ObjectMapper;

public class ApiTesterSwing extends JFrame {
    private JTabbedPane tabbedPane;
    private JTextArea historyArea;
    private boolean darkMode = false;
    private List<String> history = new ArrayList<>();
    private JPanel mainPanel;

    public ApiTesterSwing() {
        setTitle("API Tester - Postman Clone (Swing)");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(1200, 800);
        setLocationRelativeTo(null);

        initializeUI();
        applyLightTheme();
    }

    private void initializeUI() {
        // Main layout
        mainPanel = new JPanel(new BorderLayout());

        // Menu Bar
        JMenuBar menuBar = createMenuBar();
        setJMenuBar(menuBar);

        // History Panel
        JPanel historyPanel = createHistoryPanel();
        mainPanel.add(historyPanel, BorderLayout.EAST);

        // Tabbed Pane for requests
        tabbedPane = new JTabbedPane();
        mainPanel.add(tabbedPane, BorderLayout.CENTER);
        addNewTab();

        // New Tab Button
        JButton newTabButton = new JButton("+ New Tab");
        newTabButton.addActionListener(e -> addNewTab());
        mainPanel.add(newTabButton, BorderLayout.SOUTH);

        add(mainPanel);
    }

    private JMenuBar createMenuBar() {
        JMenuBar menuBar = new JMenuBar();

        // File Menu
        JMenu fileMenu = new JMenu("File");
        JMenuItem newTab = new JMenuItem("New Tab");
        JMenuItem closeTab = new JMenuItem("Close Tab");
        JMenuItem exit = new JMenuItem("Exit");

        newTab.addActionListener(e -> addNewTab());
        closeTab.addActionListener(e -> closeCurrentTab());
        exit.addActionListener(e -> System.exit(0));

        fileMenu.add(newTab);
        fileMenu.add(closeTab);
        fileMenu.addSeparator();
        fileMenu.add(exit);

        // View Menu
        JMenu viewMenu = new JMenu("View");
        JMenuItem toggleDarkMode = new JMenuItem("Toggle Dark Mode");
        JMenuItem saveHistory = new JMenuItem("Save History");
        JMenuItem loadHistory = new JMenuItem("Load History");
        JMenuItem clearHistory = new JMenuItem("Clear History");

        toggleDarkMode.addActionListener(e -> toggleDarkMode());
        saveHistory.addActionListener(e -> saveHistory());
        loadHistory.addActionListener(e -> loadHistory());
        clearHistory.addActionListener(e -> clearHistory());

        viewMenu.add(toggleDarkMode);
        viewMenu.addSeparator();
        viewMenu.add(saveHistory);
        viewMenu.add(loadHistory);
        viewMenu.add(clearHistory);

        menuBar.add(fileMenu);
        menuBar.add(viewMenu);

        return menuBar;
    }

    private JPanel createHistoryPanel() {
        JPanel historyPanel = new JPanel(new BorderLayout());
        historyPanel.setPreferredSize(new Dimension(250, 0));
        historyPanel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        JLabel historyLabel = new JLabel("Request History");
        historyLabel.setFont(historyLabel.getFont().deriveFont(Font.BOLD, 14));

        historyArea = new JTextArea();
        historyArea.setEditable(false);
        historyArea.setLineWrap(true);
        historyArea.setWrapStyleWord(true);

        JScrollPane historyScroll = new JScrollPane(historyArea);
        historyScroll.setPreferredSize(new Dimension(230, 0));

        JButton clearHistoryBtn = new JButton("Clear History");
        clearHistoryBtn.addActionListener(e -> clearHistory());

        historyPanel.add(historyLabel, BorderLayout.NORTH);
        historyPanel.add(historyScroll, BorderLayout.CENTER);
        historyPanel.add(clearHistoryBtn, BorderLayout.SOUTH);

        return historyPanel;
    }

    private void addNewTab() {
        JPanel tabPanel = new JPanel(new BorderLayout());
        tabPanel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        // Top controls
        JPanel topPanel = createTopControls();
        tabPanel.add(topPanel, BorderLayout.NORTH);

        // Center - Request & Response
        JSplitPane centerSplit = createCenterSplitPane();
        tabPanel.add(centerSplit, BorderLayout.CENTER);

        String tabTitle = "Request " + (tabbedPane.getTabCount() + 1);
        tabbedPane.addTab(tabTitle, tabPanel);
        tabbedPane.setSelectedIndex(tabbedPane.getTabCount() - 1);
    }

    private JPanel createTopControls() {
        JPanel panel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5);
        gbc.fill = GridBagConstraints.HORIZONTAL;

        // Method selection
        gbc.gridx = 0; gbc.gridy = 0;
        panel.add(new JLabel("Method:"), gbc);

        gbc.gridx = 1; gbc.gridy = 0;
        String[] methods = {"GET", "POST", "PUT", "DELETE", "PATCH", "HEAD", "OPTIONS"};
        JComboBox<String> methodBox = new JComboBox<>(methods);
        methodBox.setSelectedItem("GET");
        panel.add(methodBox, gbc);

        // URL field
        gbc.gridx = 0; gbc.gridy = 1;
        panel.add(new JLabel("URL:"), gbc);

        gbc.gridx = 1; gbc.gridy = 1;
        gbc.weightx = 1.0;
        JTextField urlField = new JTextField("https://jsonplaceholder.typicode.com/posts");
        urlField.setToolTipText("https://api.example.com/endpoint");
        panel.add(urlField, gbc);

        // Buttons
        gbc.gridx = 2; gbc.gridy = 0;
        gbc.weightx = 0;
        gbc.gridheight = 2;
        gbc.fill = GridBagConstraints.VERTICAL;
        
        JPanel buttonPanel = new JPanel(new GridLayout(2, 1, 5, 5));
        JButton sendButton = new JButton("Send");
        sendButton.setBackground(new Color(76, 175, 80));
        sendButton.setForeground(Color.WHITE);
        
        JButton clearButton = new JButton("Clear");
        
        buttonPanel.add(sendButton);
        buttonPanel.add(clearButton);
        panel.add(buttonPanel, gbc);

        // Store references for event handling
        panel.putClientProperty("methodBox", methodBox);
        panel.putClientProperty("urlField", urlField);
        panel.putClientProperty("sendButton", sendButton);
        panel.putClientProperty("clearButton", clearButton);

        return panel;
    }

    private JSplitPane createCenterSplitPane() {
        JSplitPane mainSplit = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT);
        mainSplit.setDividerLocation(0.3);

        // Left side - Headers
        JPanel leftPanel = createLeftPanel();
        mainSplit.setLeftComponent(leftPanel);

        // Right side - Request and Response
        JSplitPane rightSplit = new JSplitPane(JSplitPane.VERTICAL_SPLIT);
        rightSplit.setDividerLocation(0.5);

        // Request Body
        JPanel requestPanel = new JPanel(new BorderLayout());
        requestPanel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));
        
        JLabel requestLabel = new JLabel("Request Body:");
        JTextArea requestArea = new JTextArea();
        requestArea.setText("{\n    \"title\": \"foo\",\n    \"body\": \"bar\",\n    \"userId\": 1\n}");
        requestArea.setToolTipText("Enter JSON request body...");
        
        JScrollPane requestScroll = new JScrollPane(requestArea);
        requestPanel.add(requestLabel, BorderLayout.NORTH);
        requestPanel.add(requestScroll, BorderLayout.CENTER);

        // Response Area
        JPanel responsePanel = new JPanel(new BorderLayout());
        responsePanel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));
        
        JLabel responseLabel = new JLabel("Response:");
        JTextArea responseArea = new JTextArea();
        responseArea.setEditable(false);
        
        JScrollPane responseScroll = new JScrollPane(responseArea);
        
        // Response status
        JLabel statusLabel = new JLabel();
        statusLabel.setFont(statusLabel.getFont().deriveFont(Font.BOLD));
        
        JPanel statusPanel = new JPanel(new BorderLayout());
        statusPanel.add(responseLabel, BorderLayout.WEST);
        statusPanel.add(statusLabel, BorderLayout.CENTER);
        
        responsePanel.add(statusPanel, BorderLayout.NORTH);
        responsePanel.add(responseScroll, BorderLayout.CENTER);

        rightSplit.setLeftComponent(requestPanel);
        rightSplit.setRightComponent(responsePanel);

        mainSplit.setRightComponent(rightSplit);

        // Set up event handlers
        setupEventHandlers(leftPanel, requestArea, responseArea, statusLabel);

        return mainSplit;
    }

    private JPanel createLeftPanel() {
        JPanel leftPanel = new JPanel(new BorderLayout());
        leftPanel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        // Headers section
        JLabel headersLabel = new JLabel("Headers:");
        headersLabel.setFont(headersLabel.getFont().deriveFont(Font.BOLD));

        // Headers table
        String[] columnNames = {"Key", "Value"};
        Object[][] data = {
            {"Content-Type", "application/json"},
            {"Accept", "application/json"}
        };
        
        DefaultTableModel tableModel = new DefaultTableModel(data, columnNames) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return true;
            }
        };
        
        JTable headersTable = new JTable(tableModel);
        headersTable.setRowHeight(25);
        JScrollPane tableScroll = new JScrollPane(headersTable);

        // Header buttons
        JPanel headerButtons = new JPanel(new FlowLayout(FlowLayout.LEFT));
        JButton addHeaderBtn = new JButton("Add");
        JButton removeHeaderBtn = new JButton("Remove");
        
        addHeaderBtn.addActionListener(e -> tableModel.addRow(new Object[]{"", ""}));
        removeHeaderBtn.addActionListener(e -> {
            int selectedRow = headersTable.getSelectedRow();
            if (selectedRow != -1) {
                tableModel.removeRow(selectedRow);
            }
        });
        
        headerButtons.add(addHeaderBtn);
        headerButtons.add(removeHeaderBtn);

        leftPanel.add(headersLabel, BorderLayout.NORTH);
        leftPanel.add(tableScroll, BorderLayout.CENTER);
        leftPanel.add(headerButtons, BorderLayout.SOUTH);

        // Store reference to headers table
        leftPanel.putClientProperty("headersTable", headersTable);

        return leftPanel;
    }

    private void setupEventHandlers(JPanel leftPanel, JTextArea requestArea, 
                                  JTextArea responseArea, JLabel statusLabel) {
        // Get the current tab panel
        JPanel tabPanel = (JPanel) tabbedPane.getComponentAt(tabbedPane.getSelectedIndex());
        JPanel topPanel = (JPanel) tabPanel.getComponent(0);
        
        JComboBox<String> methodBox = (JComboBox<String>) topPanel.getClientProperty("methodBox");
        JTextField urlField = (JTextField) topPanel.getClientProperty("urlField");
        JButton sendButton = (JButton) topPanel.getClientProperty("sendButton");
        JButton clearButton = (JButton) topPanel.getClientProperty("clearButton");
        JTable headersTable = (JTable) leftPanel.getClientProperty("headersTable");

        sendButton.addActionListener(e -> {
            sendRequest(
                (String) methodBox.getSelectedItem(),
                urlField.getText(),
                requestArea.getText(),
                responseArea,
                statusLabel,
                headersTable
            );
        });

        clearButton.addActionListener(e -> {
            requestArea.setText("");
            responseArea.setText("");
            statusLabel.setText("");
        });
    }

    private void sendRequest(String method, String urlString, String body, 
                           JTextArea responseArea, JLabel statusLabel, JTable headersTable) {
        SwingWorker<String, Void> worker = new SwingWorker<String, Void>() {
            @Override
            protected String doInBackground() throws Exception {
                long startTime = System.currentTimeMillis();
                try {
                    URL url = new URL(urlString);
                    HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                    conn.setRequestMethod(method);
                    conn.setConnectTimeout(30000);
                    conn.setReadTimeout(30000);

                    // Set headers
                    DefaultTableModel model = (DefaultTableModel) headersTable.getModel();
                    for (int i = 0; i < model.getRowCount(); i++) {
                        String key = (String) model.getValueAt(i, 0);
                        String value = (String) model.getValueAt(i, 1);
                        if (key != null && !key.trim().isEmpty() && value != null && !value.trim().isEmpty()) {
                            conn.setRequestProperty(key.trim(), value.trim());
                        }
                    }

                    // Add request body for methods that support it
                    if (!method.equals("GET") && !method.equals("DELETE") && !method.equals("HEAD")) {
                        if (body != null && !body.trim().isEmpty()) {
                            conn.setDoOutput(true);
                            try (OutputStream os = conn.getOutputStream()) {
                                os.write(body.getBytes());
                                os.flush();
                            }
                        }
                    }

                    int responseCode = conn.getResponseCode();
                    String responseMessage = conn.getResponseMessage();
                    
                    BufferedReader reader = new BufferedReader(new InputStreamReader(
                            responseCode >= 200 && responseCode < 300 ? conn.getInputStream() : conn.getErrorStream()
                    ));
                    
                    StringBuilder response = new StringBuilder();
                    String line;
                    while ((line = reader.readLine()) != null) {
                        response.append(line).append("\n");
                    }

                    long responseTime = System.currentTimeMillis() - startTime;
                    
                    String historyEntry = method + " " + urlString + " â†’ " + responseCode + " (" + responseTime + "ms)";
                    history.add(0, historyEntry);
                    updateHistoryArea();

                    return responseCode + " " + responseMessage + " | Time: " + responseTime + "ms\n\n" + formatJson(response.toString());
                    
                } catch (Exception ex) {
                    return "Error: " + ex.getMessage();
                }
            }

            @Override
            protected void done() {
                try {
                    String result = get();
                    if (result.startsWith("Error:")) {
                        statusLabel.setForeground(Color.RED);
                        statusLabel.setText("Request Failed");
                    } else {
                        statusLabel.setForeground(Color.GREEN);
                        String status = result.substring(0, result.indexOf("\n\n"));
                        statusLabel.setText(status);
                    }
                    responseArea.setText(result);
                } catch (Exception ex) {
                    statusLabel.setForeground(Color.RED);
                    statusLabel.setText("Request Failed");
                    responseArea.setText("Error: " + ex.getMessage());
                }
            }
        };

        // Show loading
        statusLabel.setForeground(Color.BLUE);
        statusLabel.setText("Sending request...");
        
        worker.execute();
    }

    private String formatJson(String json) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            Object obj = mapper.readValue(json, Object.class);
            return mapper.writerWithDefaultPrettyPrinter().writeValueAsString(obj);
        } catch (Exception e) {
            return json; // Return as-is if not valid JSON
        }
    }

    private void toggleDarkMode() {
        if (darkMode) {
            applyLightTheme();
        } else {
            applyDarkTheme();
        }
        darkMode = !darkMode;
        revalidate();
        repaint();
    }

    private void applyLightTheme() {
        Color bgColor = Color.WHITE;
        Color fgColor = Color.BLACK;
        applyTheme(bgColor, fgColor);
    }

    private void applyDarkTheme() {
        Color bgColor = new Color(30, 30, 30);
        Color fgColor = Color.WHITE;
        applyTheme(bgColor, fgColor);
    }

    private void applyTheme(Color bgColor, Color fgColor) {
        mainPanel.setBackground(bgColor);
        mainPanel.setForeground(fgColor);
        
        // Recursively apply to all components
        applyThemeToComponent(mainPanel, bgColor, fgColor);
        
        // Special handling for text areas
        Component[] components = mainPanel.getComponents();
        for (Component comp : components) {
            if (comp instanceof JScrollPane) {
                JViewport viewport = ((JScrollPane) comp).getViewport();
                if (viewport.getView() instanceof JTextArea) {
                    JTextArea textArea = (JTextArea) viewport.getView();
                    textArea.setBackground(bgColor);
                    textArea.setForeground(fgColor);
                    textArea.setCaretColor(fgColor);
                }
            }
        }
    }

    private void applyThemeToComponent(Container container, Color bgColor, Color fgColor) {
        for (Component comp : container.getComponents()) {
            if (comp instanceof JComponent) {
                JComponent jcomp = (JComponent) comp;
                jcomp.setBackground(bgColor);
                jcomp.setForeground(fgColor);
                
                if (comp instanceof JTextArea) {
                    JTextArea textArea = (JTextArea) comp;
                    textArea.setBackground(bgColor);
                    textArea.setForeground(fgColor);
                    textArea.setCaretColor(fgColor);
                } else if (comp instanceof JTextField) {
                    JTextField textField = (JTextField) comp;
                    textField.setBackground(bgColor);
                    textField.setForeground(fgColor);
                    textField.setCaretColor(fgColor);
                } else if (comp instanceof JComboBox) {
                    JComboBox<?> combo = (JComboBox<?>) comp;
                    combo.setBackground(bgColor);
                    combo.setForeground(fgColor);
                } else if (comp instanceof JTable) {
                    JTable table = (JTable) comp;
                    table.setBackground(bgColor);
                    table.setForeground(fgColor);
                    table.setGridColor(fgColor.darker());
                }
            }
            if (comp instanceof Container) {
                applyThemeToComponent((Container) comp, bgColor, fgColor);
            }
        }
    }

    private void updateHistoryArea() {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < Math.min(history.size(), 50); i++) {
            sb.append(history.get(i)).append("\n");
        }
        historyArea.setText(sb.toString());
    }

    private void saveHistory() {
        try (BufferedWriter writer = new BufferedWriter(new FileWriter("api_tester_history.txt"))) {
            for (String h : history) {
                writer.write(h);
                writer.newLine();
            }
            showAlert("Success", "History saved to api_tester_history.txt");
        } catch (IOException e) {
            showAlert("Error", "Failed to save history: " + e.getMessage());
        }
    }

    private void loadHistory() {
        history.clear();
        try (BufferedReader reader = new BufferedReader(new FileReader("api_tester_history.txt"))) {
            String line;
            while ((line = reader.readLine()) != null) {
                history.add(line);
            }
            updateHistoryArea();
            showAlert("Success", "History loaded from api_tester_history.txt");
        } catch (IOException e) {
            showAlert("Error", "Failed to load history: " + e.getMessage());
        }
    }

    private void clearHistory() {
        history.clear();
        updateHistoryArea();
    }

    private void closeCurrentTab() {
        int selectedIndex = tabbedPane.getSelectedIndex();
        if (selectedIndex != -1 && tabbedPane.getTabCount() > 1) {
            tabbedPane.removeTabAt(selectedIndex);
        }
    }

    private void showAlert(String title, String message) {
        JOptionPane.showMessageDialog(this, message, title, JOptionPane.INFORMATION_MESSAGE);
    }

    public static void main(String[] args) {
        // Set system look and feel
        try {
            UIManager.setLookAndFeel(UIManager.getSystemLookAndFeel());
        } catch (Exception e) {
            e.printStackTrace();
        }

        SwingUtilities.invokeLater(() -> {
            new ApiTesterSwing().setVisible(true);
        });
    }
}
